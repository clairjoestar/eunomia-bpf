name: Deploy examples

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    name: Deploy gh-pages
    runs-on: ubuntu-latest
    container:
      image: ubuntu:24.04
      options: --privileged
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    steps:
      - name: Install git and basic tools
        run: |
          apt-get update
          apt-get install -y git sudo

      - uses: actions/checkout@v3.3.0

      - name: Fix git safe directory
        run: |
          git config --global --add safe.directory /__w/eunomia-bpf/eunomia-bpf
          git config --global --add safe.directory '*'

      - name: Install build dependencies
        run: |
          apt-get update
          apt-get install -y \
            curl \
            build-essential \
            clang \
            llvm \
            libelf-dev \
            zlib1g-dev \
            cmake \
            pkg-config \
            libssl-dev \
            ca-certificates \
            wget \
            software-properties-common \
            rsync

      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
          . $HOME/.cargo/env
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          rustc --version
          cargo --version

      - name: get submodule
        run: git submodule update --init --recursive --remote

      - name: install deps and build with kernel compatibility patch
        run: |
          set -e
          . $HOME/.cargo/env

          echo "=== Installing dependencies ==="
          make -C compiler install-deps
          make -C ecli install-deps

          echo "=== Creating kernel compatibility patch script ==="
          cat > /tmp/patch_libbpf.sh << 'PATCH_EOF'
          #!/bin/bash
          # Patch libbpf skel_internal.h for kernel 6.8 compatibility
          set -e

          echo "Looking for skel_internal.h to patch..."
          SKEL_FILES=$(find third_party/bpftool -name "skel_internal.h" -type f 2>/dev/null || true)

          if [ -z "$SKEL_FILES" ]; then
            echo "WARNING: No skel_internal.h files found yet"
            exit 0
          fi

          for SKEL_FILE in $SKEL_FILES; do
            echo "Patching $SKEL_FILE for Ubuntu 24.04 (kernel 6.8)..."

            # Create backup
            cp "$SKEL_FILE" "$SKEL_FILE.orig"

            # Comment out code using kernel features only available in 6.12+
            sed -i 's/offsetofend(union bpf_attr, excl_prog_hash_size)/sizeof(union bpf_attr)/g' "$SKEL_FILE"
            sed -i 's/\([[:space:]]*\)attr\.excl_prog_hash = /\1\/\/ attr.excl_prog_hash = /g' "$SKEL_FILE"
            sed -i 's/\([[:space:]]*\)attr\.excl_prog_hash_size = /\1\/\/ attr.excl_prog_hash_size = /g' "$SKEL_FILE"
            sed -i 's/\([[:space:]]*\)__u8 sha\[SHA256_DIGEST_LENGTH\];/\1\/\/ __u8 sha[SHA256_DIGEST_LENGTH];/g' "$SKEL_FILE"
            sed -i 's/\([[:space:]]*\)info\.hash = /\1\/\/ info.hash = /g' "$SKEL_FILE"
            sed -i 's/\([[:space:]]*\)info\.hash_size = /\1\/\/ info.hash_size = /g' "$SKEL_FILE"
            sed -i 's/offsetofend(union bpf_attr, keyring_id)/sizeof(union bpf_attr)/g' "$SKEL_FILE"
            sed -i 's/\([[:space:]]*\)attr\.signature = /\1\/\/ attr.signature = /g' "$SKEL_FILE"
            sed -i 's/\([[:space:]]*\)attr\.signature_size = /\1\/\/ attr.signature_size = /g' "$SKEL_FILE"
            sed -i 's/\([[:space:]]*\)attr\.keyring_id = /\1\/\/ attr.keyring_id = /g' "$SKEL_FILE"

            echo "✓ Patched $SKEL_FILE successfully"
          done
          PATCH_EOF

          chmod +x /tmp/patch_libbpf.sh

          echo "=== Building compiler with patched bpftool ==="
          # Start the build which will checkout libbpf
          cd compiler
          make -C ../third_party/bpftool/src clean || true

          # Trigger libbpf checkout by starting bpftool build
          cd ../third_party/bpftool/src
          make libbpf || true

          # Now apply the patch
          cd ../../..
          /tmp/patch_libbpf.sh

          # Continue building
          cd compiler
          make
          make install

          echo "=== Building ecli ==="
          cd ../ecli
          make install
          cp target/release/ecli-rs ../examples/tests/ecli

          echo "=== Installing wasm clang ==="
          cd ../examples/tests
          make install-wasm-clang

          echo "✓ All dependencies installed and built successfully"

      - name: test build runners
        run: |
          . $HOME/.cargo/env
          make -C examples

      - name: test examples
        run: |
          set -e
          . $HOME/.cargo/env

          echo "=== Compiling eBPF examples (execution skipped in container) ==="
          echo "Note: Full eBPF execution requires kernel tracepoint access not available in containers"

          cd examples/tests
          COMPILED=0
          FAILED=0

          for dir in ../bpftools/*/; do
            example=$(basename "$dir")

            # Skip profile as configured
            if [ "$example" = "profile" ]; then
              echo "Skipping $example (as configured)"
              continue
            fi

            echo ""
            echo "=== Compiling $example ==="

            if [ -f "../bpftools/$example/$example.h" ]; then
              if ../../compiler/workspace/bin/ecc-rs "../bpftools/$example/$example.bpf.c" "../bpftools/$example/$example.h"; then
                echo "✓ $example compiled successfully"
                COMPILED=$((COMPILED + 1))
              else
                echo "✗ $example compilation failed"
                FAILED=$((FAILED + 1))
              fi
            else
              if ../../compiler/workspace/bin/ecc-rs "../bpftools/$example/$example.bpf.c"; then
                echo "✓ $example compiled successfully"
                COMPILED=$((COMPILED + 1))
              else
                echo "✗ $example compilation failed"
                FAILED=$((FAILED + 1))
              fi
            fi
          done

          echo ""
          echo "=== Summary ==="
          echo "Compiled: $COMPILED"
          echo "Failed: $FAILED"

          if [ $FAILED -gt 0 ]; then
            echo "Some examples failed to compile"
            exit 1
          fi

          echo "✓ All examples compiled successfully"

      - uses: JamesIves/github-pages-deploy-action@v4.4.1
        if: ${{ github.event_name == 'push' }}
        with:
          branch: gh-pages
          folder: ./examples/bpftools/
